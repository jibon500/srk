```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Earning App</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body {
            padding-top: 60px; /* Space for fixed navbar */
            background-color: #f8f9fa;
        }
        .sidebar {
            position: fixed;
            top: 56px; /* Height of navbar */
            bottom: 0;
            left: 0;
            z-index: 100; /* Behind the navbar */
            padding: 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: #fff;
            /* Initially hide the sidebar */
            display: none;
        }
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 56px); /* Adjust for navbar height */
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto; /* Scrollable contents if viewport is shorter than content. */
        }
        .sidebar .nav-link {
            font-weight: 500;
            color: #333;
        }
        .sidebar .nav-link.active {
            color: #007bff;
        }
        main[role="main"] {
            padding-top: 20px;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .data-table-container {
            max-height: 70vh;
            overflow-y: auto;
        }
        .status-badge {
            font-size: 0.75em;
        }
        .action-btn {
            margin: 2px;
            padding: 5px 10px;
            font-size: 0.8em;
        }
        .loading-spinner {
            display: none;
            margin: 20px auto;
        }
        .toast-container {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 1050;
        }
        .config-value {
            font-weight: bold;
            color: #007bff;
        }
        /* --- Update: Larger message history area --- */
        #reply-message-history {
            max-height: 60vh; /* Increased max-height for message history */
            min-height: 300px; /* Ensure a minimum height */
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bs-body-bg); /* Use Bootstrap's body background */
            border-radius: 8px;
            border: 1px solid var(--bs-border-color); /* Use Bootstrap's border color */
            display: flex; /* ফ্লেক্সবক্স লেআউট */
            flex-direction: column; /* কলাম অর্ডার */
        }
        .message-bubble {
            padding: 12px 18px; /* Increased padding */
            border-radius: 20px; /* Increased border-radius */
            margin-bottom: 12px; /* Increased margin */
            max-width: 85%; /* Slightly increased max-width */
            word-wrap: break-word;
            font-size: 15px; /* Increased font size */
        }
        .sent-message { /* Admin messages */
            background-color: #007bff; /* Bootstrap primary color */
            color: white;
            margin-left: auto; /* Align right for admin */
        }
        .received-message { /* User messages */
            background-color: #e9ecef; /* Bootstrap light color */
            color: #212529; /* Bootstrap dark color */
            margin-right: auto; /* Align left for user */
        }
        /* --- End Update --- */
        /* --- Update: Larger Notice Modal --- */
        .modal-xl {
            max-width: 800px; /* Adjust width as needed */
        }
        .notice-message-large {
            min-height: 150px; /* Make the textarea taller */
        }
        /* --- End Update --- */
        /* Disable links in navbar and sidebar when not logged in */
        .nav-link.disabled {
            color: #ccc !important;
            pointer-events: none;
            cursor: not-allowed;
        }
        #nav-dashboard, #user-info {
            display: none;
        }
        /* Initially hide sidebar links */
        #sidebar-dashboard, #sidebar-config, #sidebar-users,
        #sidebar-withdrawals, #sidebar-messages, #sidebar-notices {
            display: none;
        }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Admin Panel</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav me-auto mb-2 mb-md-0">
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('login-section'); return false;" id="nav-login">Login</a>
                </li>
                <!-- Initially disabled links -->
                <li class="nav-item">
                    <a class="nav-link disabled" href="#" onclick="return false;" id="nav-dashboard-link">Dashboard</a>
                </li>
                 <li class="nav-item">
                    <a class="nav-link disabled" href="#" onclick="return false;" id="nav-config-link">App Configuration</a>
                </li>
                 <li class="nav-item">
                    <a class="nav-link disabled" href="#" onclick="return false;" id="nav-users-link">Users</a>
                </li>
                 <li class="nav-item">
                    <a class="nav-link disabled" href="#" onclick="return false;" id="nav-withdrawals-link">Withdrawals</a>
                </li>
                 <li class="nav-item">
                    <a class="nav-link disabled" href="#" onclick="return false;" id="nav-messages-link">User Messages</a>
                </li>
                 <li class="nav-item">
                    <a class="nav-link disabled" href="#" onclick="return false;" id="nav-notices-link">Important Notices</a>
                </li>
            </ul>
            <span class="navbar-text" id="user-info">
                Logged in as: <span id="logged-in-email"></span>
                <button class="btn btn-outline-light btn-sm ms-2" onclick="logout()">Logout</button>
            </span>
        </div>
    </div>
</nav>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
            <div class="position-sticky pt-3 sidebar-sticky">
                <ul class="nav flex-column">
                    <!-- Initially disabled links -->
                    <li class="nav-item">
                        <a class="nav-link disabled" href="#" onclick="return false;" id="sidebar-dashboard-link">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" href="#" onclick="return false;" id="sidebar-config-link">
                            <i class="fas fa-cogs"></i> App Configuration
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" href="#" onclick="return false;" id="sidebar-users-link">
                            <i class="fas fa-users"></i> Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" href="#" onclick="return false;" id="sidebar-withdrawals-link">
                            <i class="fas fa-money-bill-wave"></i> Withdrawals
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" href="#" onclick="return false;" id="sidebar-messages-link">
                            <i class="fas fa-comments"></i> User Messages
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" href="#" onclick="return false;" id="sidebar-notices-link">
                            <i class="fas fa-bullhorn"></i> Important Notices
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4" role="main">
            <div id="loading-spinner" class="spinner-border text-primary loading-spinner" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <!-- Login Section -->
            <div id="login-section" class="section active">
                <div class="d-flex justify-content-center align-items-center" style="height: 80vh;">
                    <div class="card p-4" style="width: 100%; max-width: 400px;">
                        <div class="card-body">
                            <h3 class="card-title text-center mb-4">Admin Login</h3>
                            <div class="mb-3">
                                <label for="admin-uid" class="form-label">Admin UID</label>
                                <input type="text" class="form-control" id="admin-uid" placeholder="Enter Admin UID" required>
                            </div>
                            <button class="btn btn-primary w-100" onclick="loginByUid()">Login</button>
                            <div id="login-error" class="text-danger mt-2" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Dashboard</h1>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card text-white bg-primary">
                            <div class="card-header">Total Users</div>
                            <div class="card-body">
                                <h5 class="card-title" id="total-users-count">0</h5>
                                <p class="card-text">Registered users</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card text-white bg-success">
                            <div class="card-header">Total Balance</div>
                            <div class="card-body">
                                <h5 class="card-title" id="total-balance-sum">$0.00</h5>
                                <p class="card-text">Across all users</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card text-white bg-info">
                            <div class="card-header">Pending Withdrawals</div>
                            <div class="card-body">
                                <h5 class="card-title" id="pending-withdrawals-count">0</h5>
                                <p class="card-text">Requests awaiting action</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                         <h4>Global Configuration</h4>
                         <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Ad System Status
                                <span class="config-value" id="dashboard-ad-system-status">Loading...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Daily Ad Limit Per User
                                <span class="config-value" id="dashboard-daily-ad-limit">Loading...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Reset Timer (Hours)
                                <span class="config-value" id="dashboard-reset-timer-hours">Loading...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Points Per Ad
                                <span class="config-value" id="dashboard-points-per-ad">Loading...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Coins for Conversion
                                <span class="config-value" id="dashboard-coins-for-conversion">Loading...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Value Per Conversion ($)
                                <span class="config-value" id="dashboard-value-per-conversion">Loading...</span>
                            </li>
                         </ul>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h4>Recent User Activity</h4>
                        <ul class="list-group" id="recent-user-activity">
                            <li class="list-group-item">No recent activity.</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h4>Recent Withdrawal Requests</h4>
                        <ul class="list-group" id="recent-withdrawal-requests">
                             <li class="list-group-item">No recent requests.</li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- App Configuration Section -->
            <div id="config-section" class="section">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">App Configuration</h1>
                    <button class="btn btn-success" onclick="saveAppConfig()"><i class="fas fa-save"></i> Save Configuration</button>
                </div>
                <form id="app-config-form">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="pointsPerAd" class="form-label">Points Per Ad</label>
                            <!-- Added 'name' attribute -->
                            <input type="number" class="form-control" id="pointsPerAd" name="pointsPerAd" required>
                        </div>
                        <div class="col-md-6">
                            <label for="coinsForConversion" class="form-label">Coins for Conversion</label>
                            <!-- Added 'name' attribute -->
                            <input type="number" class="form-control" id="coinsForConversion" name="coinsForConversion" required>
                        </div>
                        <div class="col-md-6">
                            <label for="valuePerConversion" class="form-label">Value Per Conversion ($)</label>
                            <!-- Added 'name' attribute -->
                            <input type="number" class="form-control" id="valuePerConversion" name="valuePerConversion" step="0.01" required>
                        </div>
                        <div class="col-md-6">
                            <label for="referralRewardCoins" class="form-label">Referral Reward Coins</label>
                            <!-- Added 'name' attribute -->
                            <input type="number" class="form-control" id="referralRewardCoins" name="referralRewardCoins" required>
                        </div>
                        <div class="col-md-6">
                            <label for="referralClaimThreshold" class="form-label">Referral Claim Threshold</label>
                            <!-- Added 'name' attribute -->
                            <input type="number" class="form-control" id="referralClaimThreshold" name="referralClaimThreshold" required>
                        </div>
                        <div class="col-md-6">
                            <label for="minWithdrawAmount" class="form-label">Min Withdraw Amount ($)</label>
                            <!-- Added 'name' attribute -->
                            <input type="number" class="form-control" id="minWithdrawAmount" name="minWithdrawAmount" step="0.01" required>
                        </div>
                        <div class="col-md-6">
                            <label for="dailyAdLimitPerUser" class="form-label">Daily Ad Limit Per User</label>
                            <!-- Added 'name' attribute -->
                            <input type="number" class="form-control" id="dailyAdLimitPerUser" name="dailyAdLimitPerUser" required>
                        </div>
                        <div class="col-md-6">
                            <label for="resetTimerHours" class="form-label">Reset Timer (Hours)</label>
                            <!-- Added 'name' attribute -->
                            <input type="number" class="form-control" id="resetTimerHours" name="resetTimerHours" min="1" required>
                            <div class="form-text">Number of hours after which the daily ad counter resets for each user.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="isAdSystemActive" class="form-label">Ad System Status</label>
                            <!-- Added 'name' attribute -->
                            <select class="form-select" id="isAdSystemActive" name="isAdSystemActive">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <!-- Users Section -->
            <div id="users-section" class="section">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Users Management</h1>
                </div>
                <div class="mb-3">
                    <input type="text" class="form-control" id="user-search" placeholder="Search users by ID or name...">
                </div>
                <div class="data-table-container">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Points</th>
                                <th>Balance ($)</th>
                                <th>Referrals</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- Users will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Withdrawals Section -->
            <div id="withdrawals-section" class="section">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Withdrawal Requests</h1>
                </div>
                <div class="data-table-container">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>User ID</th>
                                <th>Amount ($)</th>
                                <th>Method</th>
                                <th>Mobile</th>
                                <th>Timestamp</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawals-table-body">
                            <!-- Withdrawals will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- User Messages Section -->
            <div id="messages-section" class="section">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">User Messages</h1>
                </div>
                <div class="data-table-container">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>User ID</th>
                                <th>Latest Message</th>
                                <th>Timestamp</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="messages-table-body">
                            <!-- Messages will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Important Notices Section -->
            <div id="notices-section" class="section">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Important Notices</h1>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#noticeModal" onclick="openNoticeModal('new')"><i class="fas fa-plus"></i> Add New Notice</button>
                </div>
                <div class="data-table-container">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Title</th>
                                <th>Message</th>
                                <th>Timestamp</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="notices-table-body">
                            <!-- Notices will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>
<!-- Notice Modal -->
<!-- Updated Modal: Added modal-xl class for larger size -->
<div class="modal fade" id="noticeModal" tabindex="-1" aria-labelledby="noticeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl"> <!-- Changed from modal-dialog to modal-xl -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="noticeModalLabel">Add/Edit Notice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="notice-form">
                    <input type="hidden" id="notice-key">
                    <div class="mb-3">
                        <label for="notice-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="notice-title" required>
                    </div>
                    <div class="mb-3">
                        <label for="notice-message" class="form-label">Message</label>
                        <!-- Updated Textarea: Added notice-message-large class for larger size -->
                        <textarea class="form-control notice-message-large" id="notice-message" rows="6" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveNotice()">Save Notice</button>
            </div>
        </div>
    </div>
</div>
<!-- User Detail Modal -->
<div class="modal fade" id="userDetailModal" tabindex="-1" aria-labelledby="userDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userDetailModalLabel">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="user-detail-content">
                    <!-- User details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Message Reply Modal -->
<div class="modal fade" id="messageReplyModal" tabindex="-1" aria-labelledby="messageReplyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageReplyModalLabel">Reply to User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reply-user-id">
                <div id="reply-message-history">
                    <!-- Message history will be populated here -->
                    <p class="text-center text-muted">Loading messages...</p>
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" id="reply-message-input" placeholder="Type your reply...">
                    <button class="btn btn-outline-secondary" type="button" id="send-reply-message"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <!-- Clear Messages Button -->
                <button type="button" class="btn btn-danger" onclick="clearUserMessages()">Clear Messages</button>
            </div>
        </div>
    </div>
</div>
<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toast-title">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-message">
            Hello, world! This is a toast message.
        </div>
    </div>
</div>
<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- Firebase Configuration (SAME AS USER APP) ---
    const firebaseConfig = {
      apiKey: "AIzaSyD3BGZ0MVLpbQbIpLUAnYvWNEIyk7Y6S0Q",
      authDomain: "earning-app-80258.firebaseapp.com",
      databaseURL: "https://earning-app-80258-default-rtdb.firebaseio.com",
      projectId: "earning-app-80258",
      storageBucket: "earning-app-80258.appspot.com",
      messagingSenderId: "25930019210",
      appId: "1:25930019210:web:6441562811d3e7e9631873",
      measurementId: "G-P9HX6XXT1Q"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    // --- State Variables ---
    let appConfig = {};
    let usersData = {};
    let withdrawalsData = {};
    let noticesData = {};
    let messagesData = {}; // To store messages for the messages section
    let currentReplyUserId = null; // To track which user we are replying to in the modal
    let replyMessagesListener = null; // Listener for real-time updates in the reply modal
    // --- DOM Elements ---
    const loadingSpinner = document.getElementById('loading-spinner');
    const toastEl = document.getElementById('liveToast');
    const toast = new bootstrap.Toast(toastEl);
    // --- Utility Functions ---
    function showToast(title, message, isError = false) {
        document.getElementById('toast-title').textContent = title;
        document.getElementById('toast-message').textContent = message;
        toastEl.classList.toggle('bg-danger', isError);
        toastEl.classList.toggle('text-white', isError);
        toast.show();
    }
    function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
        // Show the requested section
        if (sectionId) {
            document.getElementById(sectionId).classList.add('active');
        }
        // Specific actions for sections
        if (sectionId === 'config-section') {
            loadAppConfigForEdit();
        } else if (sectionId === 'users-section') {
            loadUsers();
        } else if (sectionId === 'withdrawals-section') {
            loadWithdrawals();
        } else if (sectionId === 'messages-section') {
            loadUserMessages(); // Load messages when this section is shown
        } else if (sectionId === 'notices-section') {
            loadNotices();
        } else if (sectionId === 'dashboard-section') {
             updateDashboardStats();
        }
    }
    function showLoading(show = true) {
        if (show) {
            loadingSpinner.style.display = 'block';
        } else {
            loadingSpinner.style.display = 'none';
        }
    }
    // --- Authentication ---
    function loginByUid() {
        const uid = document.getElementById('admin-uid').value.trim();
        const errorDiv = document.getElementById('login-error');
        errorDiv.style.display = 'none';
        // Hardcoded UID for login
        const requiredUid = 'YC0HCH4qQaUuVQsrAmfk5WiBfQ43';
        if (!uid) {
            errorDiv.textContent = 'Please enter Admin UID.';
            errorDiv.style.display = 'block';
            return;
        }
        if (uid !== requiredUid) {
             errorDiv.textContent = 'Invalid Admin UID.';
             errorDiv.style.display = 'block';
             return;
        }
        // If UID is correct
        console.log("Admin logged in with UID:", uid);
        document.getElementById('logged-in-email').textContent = uid;
        document.getElementById('user-info').style.display = 'block';
        // Enable navbar links
        document.getElementById('nav-dashboard-link').classList.remove('disabled');
        document.getElementById('nav-dashboard-link').onclick = function() { showSection('dashboard-section'); return false; };
        document.getElementById('nav-config-link').classList.remove('disabled');
        document.getElementById('nav-config-link').onclick = function() { showSection('config-section'); return false; };
        document.getElementById('nav-users-link').classList.remove('disabled');
        document.getElementById('nav-users-link').onclick = function() { showSection('users-section'); return false; };
        document.getElementById('nav-withdrawals-link').classList.remove('disabled');
        document.getElementById('nav-withdrawals-link').onclick = function() { showSection('withdrawals-section'); return false; };
        document.getElementById('nav-messages-link').classList.remove('disabled');
        document.getElementById('nav-messages-link').onclick = function() { showSection('messages-section'); return false; };
        document.getElementById('nav-notices-link').classList.remove('disabled');
        document.getElementById('nav-notices-link').onclick = function() { showSection('notices-section'); return false; };
        // Show sidebar and enable sidebar links
        document.getElementById('sidebarMenu').style.display = 'block';
        document.getElementById('sidebar-dashboard-link').classList.remove('disabled');
        document.getElementById('sidebar-dashboard-link').onclick = function() { showSection('dashboard-section'); return false; };
        document.getElementById('sidebar-config-link').classList.remove('disabled');
        document.getElementById('sidebar-config-link').onclick = function() { showSection('config-section'); return false; };
        document.getElementById('sidebar-users-link').classList.remove('disabled');
        document.getElementById('sidebar-users-link').onclick = function() { showSection('users-section'); return false; };
        document.getElementById('sidebar-withdrawals-link').classList.remove('disabled');
        document.getElementById('sidebar-withdrawals-link').onclick = function() { showSection('withdrawals-section'); return false; };
        document.getElementById('sidebar-messages-link').classList.remove('disabled');
        document.getElementById('sidebar-messages-link').onclick = function() { showSection('messages-section'); return false; };
        document.getElementById('sidebar-notices-link').classList.remove('disabled');
        document.getElementById('sidebar-notices-link').onclick = function() { showSection('notices-section'); return false; };
        showSection('dashboard-section');
        initializeApp(); // Load initial data
    }
    function logout() {
        // Reset UI state
        console.log("Admin logged out");
        // Redirect to login section
        showSection('login-section');
        // Disable navbar links
        document.getElementById('nav-dashboard-link').classList.add('disabled');
        document.getElementById('nav-dashboard-link').onclick = function() { return false; };
        document.getElementById('nav-config-link').classList.add('disabled');
        document.getElementById('nav-config-link').onclick = function() { return false; };
        document.getElementById('nav-users-link').classList.add('disabled');
        document.getElementById('nav-users-link').onclick = function() { return false; };
        document.getElementById('nav-withdrawals-link').classList.add('disabled');
        document.getElementById('nav-withdrawals-link').onclick = function() { return false; };
        document.getElementById('nav-messages-link').classList.add('disabled');
        document.getElementById('nav-messages-link').onclick = function() { return false; };
        document.getElementById('nav-notices-link').classList.add('disabled');
        document.getElementById('nav-notices-link').onclick = function() { return false; };
        document.getElementById('user-info').style.display = 'none';
        // Hide sidebar and disable sidebar links
        document.getElementById('sidebarMenu').style.display = 'none';
        document.getElementById('sidebar-dashboard-link').classList.add('disabled');
        document.getElementById('sidebar-dashboard-link').onclick = function() { return false; };
        document.getElementById('sidebar-config-link').classList.add('disabled');
        document.getElementById('sidebar-config-link').onclick = function() { return false; };
        document.getElementById('sidebar-users-link').classList.add('disabled');
        document.getElementById('sidebar-users-link').onclick = function() { return false; };
        document.getElementById('sidebar-withdrawals-link').classList.add('disabled');
        document.getElementById('sidebar-withdrawals-link').onclick = function() { return false; };
        document.getElementById('sidebar-messages-link').classList.add('disabled');
        document.getElementById('sidebar-messages-link').onclick = function() { return false; };
        document.getElementById('sidebar-notices-link').classList.add('disabled');
        document.getElementById('sidebar-notices-link').onclick = function() { return false; };
         // Clear the UID input field
        document.getElementById('admin-uid').value = '';
    }
    // --- App Initialization ---
    async function initializeApp() {
        showLoading(true);
        try {
            await loadAppConfig(); // Load config first
            await Promise.all([loadUsers(), loadWithdrawals(), loadNotices()]);
            // loadUserMessages is called when the 'messages-section' is shown
        } catch (error) {
            console.error("Failed to initialize admin panel:", error);
            showToast('Error', 'Failed to initialize admin panel. Please check the console for details.', true);
        } finally {
            showLoading(false);
        }
    }
    // --- Firebase Data Loading ---
    async function loadAppConfig() {
        try {
            const snapshot = await database.ref('appConfig').once('value');
            const config = snapshot.val();
            if (config) {
                // Ensure resetTimerHours has a default value if not set
                appConfig = {
                    ...config,
                    resetTimerHours: config.resetTimerHours || 12 // Default to 12 hours
                };
                console.log("App config loaded:", appConfig);
                updateDashboardStats(); // Update dashboard when config loads
            } else {
                 // If no config exists, initialize with defaults including resetTimerHours
                 appConfig = {
                    pointsPerAd: 10,
                    coinsForConversion: 1000,
                    valuePerConversion: 0.30,
                    referralRewardCoins: 10,
                    referralClaimThreshold: 200,
                    minWithdrawAmount: 5,
                    dailyAdLimitPerUser: 10,
                    isAdSystemActive: true,
                    resetTimerHours: 12 // Default reset timer
                 };
                 console.log("App config initialized with defaults:", appConfig);
                 updateDashboardStats();
            }
        } catch (error) {
            console.error("Failed to load app config:", error);
            showToast('Error', 'Failed to load app configuration.', true);
        }
    }
    async function loadUsers() {
        showLoading(true);
        try {
            const snapshot = await database.ref('users').once('value');
            usersData = snapshot.val() || {};
            renderUsersTable();
            updateDashboardStats(); // Update dashboard when users load
        } catch (error) {
            console.error("Failed to load users:", error);
            showToast('Error', 'Failed to load users data.', true);
        } finally {
            showLoading(false);
        }
    }
    async function loadWithdrawals() {
        showLoading(true);
        try {
            // This loads all withdrawals from all users
            const snapshot = await database.ref('users').once('value');
            const users = snapshot.val() || {};
            withdrawalsData = {};
            for (const userId in users) {
                if (users[userId].withdrawHistory) {
                    for (const requestId in users[userId].withdrawHistory) {
                        // Add userId to the request data for easier handling
                        withdrawalsData[`${userId}/${requestId}`] = {
                            ...users[userId].withdrawHistory[requestId],
                            userId: userId,
                            requestId: requestId
                        };
                    }
                }
            }
            renderWithdrawalsTable();
            updateDashboardStats(); // Update dashboard when withdrawals load
        } catch (error) {
            console.error("Failed to load withdrawals:", error);
            showToast('Error', 'Failed to load withdrawal requests.', true);
        } finally {
            showLoading(false);
        }
    }
    async function loadNotices() {
        showLoading(true);
        try {
            const snapshot = await database.ref('notices').once('value');
            noticesData = snapshot.val() || {};
            renderNoticesTable();
        } catch (error) {
            console.error("Failed to load notices:", error);
            showToast('Error', 'Failed to load notices.', true);
        } finally {
            showLoading(false);
        }
    }
     async function loadUserMessages() {
        showLoading(true);
        try {
            // Load all users first to get their names/IDs
            await loadUsers(); // Ensure usersData is populated
            // This loads messages from all users
            const snapshot = await database.ref('users').once('value');
            const users = snapshot.val() || {};
            messagesData = {};
            for (const userId in users) {
                if (users[userId].adminMessages) {
                    // Get the latest message for this user
                    const userMessages = Object.values(users[userId].adminMessages);
                    if (userMessages.length > 0) {
                        // Sort by timestamp descending to get the latest
                        userMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        const latestMessage = userMessages[0];
                        messagesData[userId] = {
                            userId: userId,
                            latestMessage: latestMessage,
                            // We can also store all messages if needed for the modal
                            allMessages: users[userId].adminMessages
                        };
                    }
                }
            }
            renderMessagesTable();
        } catch (error) {
            console.error("Failed to load user messages:", error);
            showToast('Error', 'Failed to load user messages.', true);
        } finally {
            showLoading(false);
        }
    }
    // --- Dashboard Updates ---
    function updateDashboardStats() {
        // Total Users
        const totalUsers = Object.keys(usersData).length;
        document.getElementById('total-users-count').textContent = totalUsers;
        // Total Balance
        let totalBalance = 0;
        for (const userId in usersData) {
            totalBalance += usersData[userId].balance || 0;
        }
        document.getElementById('total-balance-sum').textContent = `$${totalBalance.toFixed(2)}`;
        // Pending Withdrawals
        let pendingCount = 0;
        for (const key in withdrawalsData) {
            if (withdrawalsData[key].status === 'Pending') {
                pendingCount++;
            }
        }
        document.getElementById('pending-withdrawals-count').textContent = pendingCount;
        // Global Config on Dashboard
        document.getElementById('dashboard-ad-system-status').textContent = appConfig.isAdSystemActive !== undefined ? (appConfig.isAdSystemActive ? 'Active' : 'Inactive') : 'N/A';
        document.getElementById('dashboard-daily-ad-limit').textContent = appConfig.dailyAdLimitPerUser !== undefined ? appConfig.dailyAdLimitPerUser : 'N/A';
        document.getElementById('dashboard-reset-timer-hours').textContent = appConfig.resetTimerHours !== undefined ? appConfig.resetTimerHours : 'N/A';
        document.getElementById('dashboard-points-per-ad').textContent = appConfig.pointsPerAd !== undefined ? appConfig.pointsPerAd : 'N/A';
        document.getElementById('dashboard-coins-for-conversion').textContent = appConfig.coinsForConversion !== undefined ? appConfig.coinsForConversion : 'N/A';
        document.getElementById('dashboard-value-per-conversion').textContent = appConfig.valuePerConversion !== undefined ? `$${appConfig.valuePerConversion.toFixed(2)}` : 'N/A';
        // Recent User Activity (simplified)
        const recentActivityList = document.getElementById('recent-user-activity');
        recentActivityList.innerHTML = '';
        const sortedUsers = Object.values(usersData).sort((a, b) => new Date(b.lastAdWatchTime || 0) - new Date(a.lastAdWatchTime || 0));
        const recentUsers = sortedUsers.slice(0, 5);
        if (recentUsers.length === 0) {
            recentActivityList.innerHTML = '<li class="list-group-item">No recent activity.</li>';
        } else {
            recentUsers.forEach(user => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = `${user.firstName || user.username || 'Unknown'} (ID: ${user.id}) watched an ad.`;
                if(user.lastAdWatchTime) {
                    li.innerHTML += `<br><small class="text-muted">${new Date(user.lastAdWatchTime).toLocaleString()}</small>`;
                }
                recentActivityList.appendChild(li);
            });
        }
        // Recent Withdrawal Requests
        const recentWithdrawalsList = document.getElementById('recent-withdrawal-requests');
        recentWithdrawalsList.innerHTML = '';
        const sortedWithdrawals = Object.values(withdrawalsData).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        const recentWithdrawals = sortedWithdrawals.slice(0, 5);
        if (recentWithdrawals.length === 0) {
            recentWithdrawalsList.innerHTML = '<li class="list-group-item">No recent requests.</li>';
        } else {
            recentWithdrawals.forEach(req => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.innerHTML = `
                    <strong>User ${req.userId}</strong> requested $${parseFloat(req.amount).toFixed(2)}<br>
                    <span class="badge bg-${req.status === 'Pending' ? 'warning' : req.status === 'Success' ? 'success' : req.status === 'Rejected' ? 'danger' : 'info'}">${req.status}</span>
                    <br><small class="text-muted">${new Date(req.timestamp).toLocaleString()}</small>
                `;
                recentWithdrawalsList.appendChild(li);
            });
        }
    }
    // --- App Configuration Management ---
    function loadAppConfigForEdit() {
        document.getElementById('pointsPerAd').value = appConfig.pointsPerAd || '';
        document.getElementById('coinsForConversion').value = appConfig.coinsForConversion || '';
        document.getElementById('valuePerConversion').value = appConfig.valuePerConversion || '';
        document.getElementById('referralRewardCoins').value = appConfig.referralRewardCoins || '';
        document.getElementById('referralClaimThreshold').value = appConfig.referralClaimThreshold || '';
        document.getElementById('minWithdrawAmount').value = appConfig.minWithdrawAmount || '';
        document.getElementById('dailyAdLimitPerUser').value = appConfig.dailyAdLimitPerUser || '';
        document.getElementById('resetTimerHours').value = appConfig.resetTimerHours || '12'; // Default to 12 if not set
        document.getElementById('isAdSystemActive').value = appConfig.isAdSystemActive !== undefined ? appConfig.isAdSystemActive.toString() : 'true';
    }
    // --- Updated saveAppConfig function ---
    async function saveAppConfig() {
        // Get the form element
        const form = document.getElementById('app-config-form');
        // Create a new FormData object from the form
        const formData = new FormData(form);
        // Prepare the config object to be saved
        const newConfig = {};
        // Iterate through the form data entries
        for (const [key, value] of formData.entries()) {
            // Convert values based on their expected types
            if (key === 'isAdSystemActive') {
                // Convert string 'true'/'false' to boolean
                newConfig[key] = value === 'true';
            } else if (key === 'valuePerConversion' || key === 'minWithdrawAmount') {
                // Convert to float for currency values
                newConfig[key] = parseFloat(value);
            } else {
                // Convert to integer for other numeric values
                newConfig[key] = parseInt(value);
            }
            // Basic validation: Check if conversion was successful
            if (isNaN(newConfig[key])) {
                 showToast('Error', `Invalid value for ${key}. Please check the input.`, true);
                 return; // Stop execution if validation fails
            }
        }
        try {
            // Update the configuration in Firebase
            await database.ref('appConfig').update(newConfig);
            // Update the local appConfig state with the new values
            // Ensure resetTimerHours is included if it was in the form data
            appConfig = { ...appConfig, ...newConfig };
            // Show success message
            showToast('Success', 'App configuration saved successfully.');
            // Update the dashboard stats to reflect the new configuration
            updateDashboardStats();
        } catch (error) {
            // Log the error for debugging
            console.error("Failed to save app config:", error);
            // Show error message to the user
            showToast('Error', 'Failed to save app configuration. Please try again.', true);
        }
    }
    // --- End of Updated saveAppConfig function ---
    // --- Users Management ---
    function renderUsersTable(filter = '') {
        const tableBody = document.getElementById('users-table-body');
        tableBody.innerHTML = '';
        const filteredUsers = Object.keys(usersData).filter(userId =>
            userId.toLowerCase().includes(filter.toLowerCase()) ||
            (usersData[userId].firstName && usersData[userId].firstName.toLowerCase().includes(filter.toLowerCase())) ||
            (usersData[userId].username && usersData[userId].username.toLowerCase().includes(filter.toLowerCase()))
        );
        if (filteredUsers.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No users found.</td></tr>';
            return;
        }
        filteredUsers.forEach(userId => {
            const user = usersData[userId];
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${userId}</td>
                <td>${user.firstName || user.username || 'N/A'}</td>
                <td>${user.points || 0}</td>
                <td>$${(user.balance || 0).toFixed(2)}</td>
                <td>${user.referralCount || 0}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary action-btn" onclick="viewUserDetails('${userId}')"><i class="fas fa-eye"></i> View</button>
                    <button class="btn btn-sm btn-outline-${user.isBlocked ? 'success' : 'danger'} action-btn" onclick="toggleUserBlock('${userId}', ${user.isBlocked})">
                        ${user.isBlocked ? '<i class="fas fa-unlock"></i> Unblock' : '<i class="fas fa-ban"></i> Block'}
                    </button>
                    <button class="btn btn-sm btn-outline-info action-btn" onclick="openMessageReplyModal('${userId}')"><i class="fas fa-comment"></i> Message</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }
    document.getElementById('user-search').addEventListener('input', function(e) {
        renderUsersTable(e.target.value);
    });
    async function toggleUserBlock(userId, isCurrentlyBlocked) {
        const newBlockStatus = !isCurrentlyBlocked;
        try {
            await database.ref(`users/${userId}/isBlocked`).set(newBlockStatus);
            // Update local state
            if (usersData[userId]) {
                usersData[userId].isBlocked = newBlockStatus;
            }
            showToast('Success', `User ${newBlockStatus ? 'blocked' : 'unblocked'} successfully.`);
            // Reload users table to reflect changes
            loadUsers();
        } catch (error) {
            console.error("Failed to toggle user block status:", error);
            showToast('Error', `Failed to ${newBlockStatus ? 'block' : 'unblock'} user.`, true);
        }
    }
    function viewUserDetails(userId) {
        const user = usersData[userId];
        if (!user) {
            showToast('Error', 'User not found.', true);
            return;
        }
        const detailContent = document.getElementById('user-detail-content');
        detailContent.innerHTML = `
            <h5>User ID: ${userId}</h5>
            <p><strong>Name:</strong> ${user.firstName || 'N/A'}</p>
            <p><strong>Username:</strong> ${user.username || 'N/A'}</p>
            <p><strong>Points:</strong> <span id="detail-points">${user.points || 0}</span>
                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="promptEditPoints('${userId}', ${user.points || 0})">Edit</button>
            </p>
            <p><strong>Balance ($):</strong> <span id="detail-balance">$${(user.balance || 0).toFixed(2)}</span>
                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="promptEditBalance('${userId}', ${user.balance || 0})">Edit</button>
            </p>
            <p><strong>Referral Count:</strong> ${user.referralCount || 0}</p>
            <p><strong>Referral Earnings:</strong> ${user.referralEarnings || 0}</p>
            <p><strong>Is Blocked:</strong> <span class="badge bg-${user.isBlocked ? 'danger' : 'success'}">${user.isBlocked ? 'Yes' : 'No'}</span>
                <button class="btn btn-sm btn-outline-${user.isBlocked ? 'success' : 'danger'} ms-2" onclick="toggleUserBlock('${userId}', ${user.isBlocked})">
                    ${user.isBlocked ? 'Unblock' : 'Block'}
                </button>
            </p>
            <p><strong>Ad Status:</strong>
                <select id="ad-status-select" class="form-select form-select-sm d-inline-block w-auto">
                    <option value="Active" ${user.adStatus === 'Active' ? 'selected' : ''}>Active</option>
                    <option value="Inactive" ${user.adStatus === 'Inactive' ? 'selected' : ''}>Inactive</option>
                </select>
                <button class="btn btn-sm btn-outline-primary" onclick="updateUserAdStatus('${userId}')">Update</button>
            </p>
            <p><strong>Ads Watched Today:</strong> ${user.adsWatchedToday || 0}</p>
            <p><strong>Last Ad Watch Time:</strong> ${user.lastAdWatchTime ? new Date(user.lastAdWatchTime).toLocaleString() : 'Never'}</p>
            <p><strong>Created At:</strong> ${user.createdAt ? new Date(user.createdAt).toLocaleString() : 'N/A'}</p>
        `;
        const userDetailModal = new bootstrap.Modal(document.getElementById('userDetailModal'));
        userDetailModal.show();
    }
    async function updateUserAdStatus(userId) {
        const newStatus = document.getElementById('ad-status-select').value;
        try {
            await database.ref(`users/${userId}/adStatus`).set(newStatus);
            if (usersData[userId]) {
                usersData[userId].adStatus = newStatus;
            }
            showToast('Success', 'User ad status updated successfully.');
            // Reload users table and dashboard
            loadUsers();
        } catch (error) {
            console.error("Failed to update user ad status:", error);
            showToast('Error', 'Failed to update user ad status.', true);
        }
    }
    function promptEditPoints(userId, currentPoints) {
        const newPoints = prompt("Enter new points:", currentPoints);
        if (newPoints !== null && !isNaN(newPoints)) {
            updateUserData(userId, 'points', parseInt(newPoints));
        }
    }
    function promptEditBalance(userId, currentBalance) {
        const newBalance = prompt("Enter new balance ($):", currentBalance);
        if (newBalance !== null && !isNaN(newBalance)) {
            updateUserData(userId, 'balance', parseFloat(newBalance));
        }
    }
    async function updateUserData(userId, field, value) {
        try {
            await database.ref(`users/${userId}/${field}`).set(value);
            if (usersData[userId]) {
                usersData[userId][field] = value;
            }
            showToast('Success', `${field} updated successfully.`);
            // Reload users table and dashboard
            loadUsers();
            // If it was the user detail modal, update the displayed value
            if (document.getElementById('userDetailModal').classList.contains('show')) {
                 document.getElementById(`detail-${field}`).textContent = field === 'balance' ? `$${value.toFixed(2)}` : value;
            }
        } catch (error) {
            console.error(`Failed to update user ${field}:`, error);
            showToast('Error', `Failed to update ${field}.`, true);
        }
    }
    // --- Withdrawals Management ---
    function renderWithdrawalsTable() {
        const tableBody = document.getElementById('withdrawals-table-body');
        tableBody.innerHTML = '';
        const sortedWithdrawals = Object.values(withdrawalsData).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        if (sortedWithdrawals.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No withdrawal requests found.</td></tr>';
            return;
        }
        sortedWithdrawals.forEach(request => {
            // Use the composite key to identify the request
            const compositeKey = `${request.userId}/${request.requestId}`;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${request.userId}</td>
                <td>$${parseFloat(request.amount).toFixed(2)}</td>
                <td>${request.method}</td>
                <td>${request.mobileNumber}</td>
                <td>${new Date(request.timestamp).toLocaleString()}</td>
                <td><span class="badge bg-${request.status === 'Pending' ? 'warning' : request.status === 'Success' ? 'success' : request.status === 'Rejected' ? 'danger' : 'info'}">${request.status}</span></td>
                <td>
                    <select class="form-select form-select-sm status-select" data-composite-key="${compositeKey}">
                        <option value="Pending" ${request.status === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="Processing" ${request.status === 'Processing' ? 'selected' : ''}>Processing</option>
                        <option value="Success" ${request.status === 'Success' ? 'selected' : ''}>Success</option>
                        <option value="Rejected" ${request.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                    </select>
                    <button class="btn btn-sm btn-outline-primary action-btn mt-1" onclick="updateWithdrawalStatus('${compositeKey}')">Update</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }
    async function updateWithdrawalStatus(compositeKey) {
        // compositeKey is "userId/requestId"
        const [userId, requestId] = compositeKey.split('/');
        const selectElement = document.querySelector(`.status-select[data-composite-key="${compositeKey}"]`);
        const newStatus = selectElement.value;
        try {
            await database.ref(`users/${userId}/withdrawHistory/${requestId}/status`).set(newStatus);
            // Update local state
            if (withdrawalsData[compositeKey]) {
                withdrawalsData[compositeKey].status = newStatus;
            }
            showToast('Success', 'Withdrawal status updated successfully.');
            // Reload withdrawals table
            loadWithdrawals();
        } catch (error) {
            console.error("Failed to update withdrawal status:", error);
            showToast('Error', 'Failed to update withdrawal status.', true);
        }
    }
    // --- User Messages Management ---
    function renderMessagesTable() {
        const tableBody = document.getElementById('messages-table-body');
        tableBody.innerHTML = '';
        const sortedMessages = Object.values(messagesData).sort((a, b) =>
            new Date(b.latestMessage.timestamp) - new Date(a.latestMessage.timestamp)
        );
        if (sortedMessages.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center">No user messages found.</td></tr>';
            return;
        }
        sortedMessages.forEach(msgData => {
            const userId = msgData.userId;
            const latestMsg = msgData.latestMessage;
            const user = usersData[userId] || {};
            const userName = user.firstName || user.username || 'Unknown User';
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${userId} (${userName})</td>
                <td>${latestMsg.text.substring(0, 50)}${latestMsg.text.length > 50 ? '...' : ''}</td>
                <td>${new Date(latestMsg.timestamp).toLocaleString()}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary action-btn" onclick="openMessageReplyModal('${userId}')"><i class="fas fa-reply"></i> Reply</button>
                     <button class="btn btn-sm btn-outline-danger action-btn" onclick="clearUserMessagesFromTable('${userId}')"><i class="fas fa-trash"></i> Clear</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }
     // নতুন ফাংশন: Messages table থেকে মেসেজ ক্লিয়ার করতে
    async function clearUserMessagesFromTable(userId) {
        if (!confirm(`Are you sure you want to delete ALL messages for user ${userId}? This action cannot be undone.`)) {
            return;
        }
        try {
            await database.ref(`users/${userId}/adminMessages`).remove();
            console.log(`Messages cleared for user: ${userId}`);
            showToast('Success', 'Messages cleared successfully.');
            // মেসেজ টেবিল রিফ্রেশ করুন
            loadUserMessages();
        } catch (error) {
            console.error("Error clearing messages:", error);
            showToast('Error', 'Failed to clear messages. Please try again.', true);
        }
    }
    function openMessageReplyModal(userId) {
        currentReplyUserId = userId;
        const user = usersData[userId] || {};
        const userName = user.firstName || user.username || userId;
        document.getElementById('messageReplyModalLabel').textContent = `Reply to ${userName} (${userId})`;
        document.getElementById('reply-user-id').value = userId;
        document.getElementById('reply-message-input').value = '';
        const messageHistoryDiv = document.getElementById('reply-message-history');
        messageHistoryDiv.innerHTML = '<p class="text-center text-muted">Loading messages...</p>';
        // Close any existing listener
        if (replyMessagesListener) {
             try {
                // Remove previous listener for the old user
                if(window.lastListenedUserId) {
                    const oldRef = database.ref(`users/${window.lastListenedUserId}/adminMessages`);
                    oldRef.off('value', window.lastReplyMessagesListener);
                }
             } catch (e) {
                 console.warn("Could not remove previous message listener:", e);
             }
             replyMessagesListener = null;
        }
        // Load message history
        loadReplyMessageHistory(userId);
        // Setup real-time listener for new messages
        setupReplyMessagesListener(userId);
        const messageReplyModal = new bootstrap.Modal(document.getElementById('messageReplyModal'));
        messageReplyModal.show();
        // Store the user ID for the currently listened to user
        window.lastListenedUserId = userId;
    }
    async function loadReplyMessageHistory(userId) {
        const messageHistoryDiv = document.getElementById('reply-message-history');
        try {
            const snapshot = await database.ref(`users/${userId}/adminMessages`).once('value');
            const messages = snapshot.val();
            renderReplyMessageHistory(messages);
        } catch (error) {
            console.error("Error loading reply message history:", error);
            messageHistoryDiv.innerHTML = '<p class="text-center text-danger">Failed to load messages.</p>';
        }
    }
    function renderReplyMessageHistory(messagesData) {
        const historyDiv = document.getElementById('reply-message-history');
        if (!messagesData) {
            historyDiv.innerHTML = '<p class="text-center text-muted">No messages yet. Start a conversation!</p>';
            return;
        }
        const messages = Object.values(messagesData);
        // Sort messages by timestamp (oldest first for correct display order)
        messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        // --- Update: Create message elements and append them correctly ---
        historyDiv.innerHTML = ''; // Clear previous content
        messages.forEach(msg => {
            const isUser = msg.sender === 'user'; // Check sender
            const bubbleClass = isUser ? 'received-message' : 'sent-message'; // Apply correct class
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${bubbleClass}`;
            messageDiv.innerHTML = `
                ${msg.text}
                <br><small>${new Date(msg.timestamp).toLocaleTimeString()}</small>
            `;
            historyDiv.appendChild(messageDiv);
        });
        // Scroll to bottom
        historyDiv.scrollTop = historyDiv.scrollHeight;
        // --- End Update ---
    }
    function setupReplyMessagesListener(userId) {
        const userRef = database.ref(`users/${userId}/adminMessages`);
        // Define the callback function so we can reference it for .off()
        const messagesCallback = (snapshot) => {
            const messages = snapshot.val();
            renderReplyMessageHistory(messages);
        };
        // Store the callback for later removal
        window.lastReplyMessagesListener = messagesCallback;
        // Set up new listener
        replyMessagesListener = userRef.on('value', messagesCallback, (error) => {
            console.error("Error listening to reply messages:", error);
            const messageHistoryDiv = document.getElementById('reply-message-history');
            messageHistoryDiv.innerHTML = '<p class="text-center text-danger">Error loading messages.</p>';
        });
    }
    // --- Fix: Corrected sendReplyMessage function ---
    async function sendReplyMessage() {
        const userId = document.getElementById('reply-user-id').value;
        const input = document.getElementById('reply-message-input');
        const messageText = input.value.trim();
        if (!messageText || !userId) {
            showToast('Error', 'Message text or user ID is missing.', true);
            return;
        }
        // --- Fix: Prepare message data correctly ---
        const messageData = {
            sender: 'admin', // <<--- IMPORTANT: Mark message as from admin
            text: messageText,
            timestamp: new Date().toISOString()
        };
        // --- End Fix ---
        try {
            // --- Fix: Push message to the correct Firebase path for the specific user ---
            await database.ref(`users/${userId}/adminMessages`).push(messageData);
            // --- End Fix ---
            console.log("Reply message sent to Firebase for user:", userId);
            input.value = ''; // Clear input
            // The UI will update automatically via the listener
        } catch (error) {
            console.error("Error sending reply message:", error);
            showToast('Error', 'Failed to send reply message. Please try again.', true);
        }
    }
     // --- New Function: Clear User Messages from Modal ---
    async function clearUserMessages() {
        const userId = document.getElementById('reply-user-id').value;
        if (!userId) {
            showToast('Error', 'User ID is missing.', true);
            return;
        }
        if (!confirm(`Are you sure you want to delete ALL messages for user ${userId}? This action cannot be undone.`)) {
            return;
        }
        try {
            // Remove all messages under the user's adminMessages node
            await database.ref(`users/${userId}/adminMessages`).remove();
            console.log(`Messages cleared for user: ${userId}`);
            showToast('Success', 'Messages cleared successfully.');
            // Clear the message history display in the modal
            const messageHistoryDiv = document.getElementById('reply-message-history');
            messageHistoryDiv.innerHTML = '<p class="text-center text-muted">No messages yet. Start a conversation!</p>';
            // Reload the messages section table to reflect the change
            loadUserMessages();
        } catch (error) {
            console.error("Error clearing messages:", error);
            showToast('Error', 'Failed to clear messages. Please try again.', true);
        }
    }
    // --- End New Function ---
    // --- End Fix ---
    // Attach sendReplyMessage to the button click and Enter key
    document.getElementById('send-reply-message').addEventListener('click', sendReplyMessage);
    document.getElementById('reply-message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendReplyMessage();
        }
    });
    // --- Notices Management ---
    function renderNoticesTable() {
        const tableBody = document.getElementById('notices-table-body');
        tableBody.innerHTML = '';
        const sortedNotices = Object.entries(noticesData).sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp));
        if (sortedNotices.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center">No notices found.</td></tr>';
            return;
        }
        sortedNotices.forEach(([key, notice]) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${notice.title}</td>
                <td>${notice.message.substring(0, 50)}${notice.message.length > 50 ? '...' : ''}</td>
                <td>${new Date(notice.timestamp).toLocaleString()}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary action-btn" onclick="openNoticeModal('edit', '${key}', '${notice.title}', '${notice.message.replace(/'/g, "\\'")}')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="btn btn-sm btn-outline-danger action-btn" onclick="deleteNotice('${key}')"><i class="fas fa-trash"></i> Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }
    function openNoticeModal(mode, key = '', title = '', message = '') {
        document.getElementById('notice-key').value = key;
        document.getElementById('notice-title').value = title;
        document.getElementById('notice-message').value = message;
        document.getElementById('noticeModalLabel').textContent = mode === 'edit' ? 'Edit Notice' : 'Add New Notice';
    }
    async function saveNotice() {
        const key = document.getElementById('notice-key').value;
        const title = document.getElementById('notice-title').value.trim();
        const message = document.getElementById('notice-message').value.trim();
        if (!title || !message) {
            showToast('Error', 'Title and message are required.', true);
            return;
        }
        try {
            if (key) {
                // Edit existing notice
                await database.ref(`notices/${key}`).update({
                    title: title,
                    message: message
                });
                showToast('Success', 'Notice updated successfully.');
            } else {
                // Add new notice
                const newNoticeRef = database.ref('notices').push();
                await newNoticeRef.set({
                    title: title,
                    message: message,
                    timestamp: new Date().toISOString()
                });
                showToast('Success', 'Notice added successfully.');
            }
            // Reload notices
            loadNotices();
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('noticeModal'));
            modal.hide();
        } catch (error) {
            console.error("Failed to save notice:", error);
            showToast('Error', 'Failed to save notice.', true);
        }
    }
    async function deleteNotice(key) {
        if (!confirm("Are you sure you want to delete this notice?")) {
            return;
        }
        try {
            await database.ref(`notices/${key}`).remove();
            showToast('Success', 'Notice deleted successfully.');
            // Reload notices
            loadNotices();
        } catch (error) {
            console.error("Failed to delete notice:", error);
            showToast('Error', 'Failed to delete notice.', true);
        }
    }
    // --- Cleanup listener on modal close and window unload ---
    document.getElementById('messageReplyModal').addEventListener('hidden.bs.modal', function () {
        // Remove the specific listener when the modal is closed
        if (replyMessagesListener && window.lastListenedUserId) {
            try {
                const oldRef = database.ref(`users/${window.lastListenedUserId}/adminMessages`);
                oldRef.off('value', window.lastReplyMessagesListener);
            } catch (e) {
                console.warn("Could not remove message listener on modal close:", e);
            }
            replyMessagesListener = null;
            window.lastListenedUserId = null;
            window.lastReplyMessagesListener = null;
        }
        currentReplyUserId = null; // Clear current user ID
    });
    window.addEventListener('beforeunload', () => {
       // General cleanup for other listeners (existing code)
        // ... (code for userBlockedListener, withdrawHistoryListener etc. - omitted for brevity)
        // Specific cleanup for the message reply listener
        if (replyMessagesListener && window.lastListenedUserId) {
            try {
                const oldRef = database.ref(`users/${window.lastListenedUserId}/adminMessages`);
                oldRef.off('value', window.lastReplyMessagesListener);
            } catch (e) {
                console.warn("Could not remove message listener on unload:", e);
            }
            replyMessagesListener = null;
            window.lastListenedUserId = null;
            window.lastReplyMessagesListener = null;
        }
        currentReplyUserId = null;
    });
</script>
</body>
</html>
```
